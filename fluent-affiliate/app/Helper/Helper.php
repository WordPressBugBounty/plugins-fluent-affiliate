<?php

namespace FluentAffiliate\App\Helper;

use FluentAffiliate\Framework\Support\Arr;

class Helper
{
    public static function formatMoney($amount = 0, $currency = '')
    {
        $settings = Utility::getReferralSettings();

        $config = [
            'format'          => Arr::get($settings, 'number_format', 'comma_separated'),
            'currency_symbol' => Utility::getCurrencySymbol($currency),
            'symbol_position' => Arr::get($settings, 'currency_symbol_position', 'left'),
        ];

        $thousandSeparator = ($config['format'] === 'comma_separated') ? ',' : '.';
        $decimalSeparator = ($config['format'] === 'comma_separated') ? '.' : ',';

        $formattedAmount = number_format($amount, 2, $decimalSeparator, $thousandSeparator);

        if ($config['symbol_position'] === 'left') {
            return $config['currency_symbol'] . ' ' . $formattedAmount;
        }

        return $formattedAmount . ' ' . $config['currency_symbol'];
    }

    public static function getCurrencies()
    {
        $app = \FluentAffiliate\App\App::getInstance();
        $config = $app->make('config');

        $currencies = apply_filters('fluent_affiliate/get_currencies', $config->get('currency.names', []));

        $formatted = [];

        foreach ($currencies as $code => $name) {
            $formatted[] = [
                'label' => $name,
                'value' => $code,
            ];
        }

        return $formatted;
    }

    public static function getCurrencySymbols()
    {
        $app = \FluentAffiliate\App\App::getInstance();
        $config = $app->make('config');
        return apply_filters('fluent_affiliate/currency_symbols', $config->get('currency.symbols', []));
    }

    public static function dbTransaction($callback)
    {
        $app = \FluentAffiliate\App\App::getInstance();
        $db = $app->make('db');
        $db->beginTransaction();

        try {
            $result = $callback();
            $db->commit();
            return $result;
        } catch (\Exception $e) {
            $db->rollBack();
            throw $e;
        }
    }

    public static function getReferralFormats()
    {
        return apply_filters('fluent_affiliate/referral_formats', [
            [
                'label' => __('Affiliate ID', 'fluent-affiliate'),
                'value' => 'id'
            ],
            [
                'label' => __('WordPress Username', 'fluent-affiliate'),
                'value' => 'username'
            ]
        ]);
    }

    public static function getPortalMenuItems($affiliate = null)
    {
        return apply_filters('fluent_affiliate/portal_menu_items', [
            'home' => [
                'title'   => __('Dashboard', 'fluent-affiliate'),
                'enabled' => true,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.75 16.75V9.25H16.75V16.75H10.75ZM3.25 10.75V3.25H9.25V10.75H3.25ZM7.75 9.25V4.75H4.75V9.25H7.75ZM3.25 16.75V12.25H9.25V16.75H3.25ZM4.75 15.25H7.75V13.75H4.75V15.25ZM12.25 15.25H15.25V10.75H12.25V15.25ZM10.75 3.25H16.75V7.75H10.75V3.25ZM12.25 4.75V6.25H15.25V4.75H12.25Z" fill="#2B303B"/></svg>',
                'route'   => [
                    'name' => 'home'
                ]
            ],
            'links' => [
                'title'   => __('Links', 'fluent-affiliate'),
                'enabled' => true,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.773 12.6519L13.7125 11.5899L14.773 10.5294C15.1237 10.1818 15.4023 9.76825 15.5928 9.31263C15.7833 8.857 15.8819 8.36824 15.883 7.8744C15.8841 7.38057 15.7876 6.89138 15.5991 6.43492C15.4106 5.97847 15.1338 5.56374 14.7846 5.21454C14.4354 4.86534 14.0207 4.58856 13.5643 4.40007C13.1078 4.21159 12.6186 4.11512 12.1248 4.1162C11.6309 4.11728 11.1422 4.21589 10.6865 4.40638C10.2309 4.59686 9.81741 4.87546 9.46974 5.22618L8.40924 6.28743L7.34799 5.22693L8.40999 4.16643C9.39461 3.18181 10.73 2.62866 12.1225 2.62866C13.515 2.62866 14.8504 3.18181 15.835 4.16643C16.8196 5.15105 17.3728 6.48647 17.3728 7.87893C17.3728 9.27139 16.8196 10.6068 15.835 11.5914L14.7737 12.6519H14.773ZM12.652 14.7729L11.5907 15.8334C10.6061 16.818 9.2707 17.3712 7.87824 17.3712C6.48579 17.3712 5.15036 16.818 4.16574 15.8334C3.18113 14.8488 2.62798 13.5134 2.62798 12.1209C2.62798 10.7285 3.18113 9.39305 4.16574 8.40843L5.22699 7.34793L6.28749 8.40993L5.22699 9.47043C4.87627 9.81809 4.59767 10.2316 4.40719 10.6872C4.21671 11.1429 4.1181 11.6316 4.11701 12.1255C4.11593 12.6193 4.2124 13.1085 4.40089 13.5649C4.58937 14.0214 4.86616 14.4361 5.21536 14.7853C5.56455 15.1345 5.97928 15.4113 6.43574 15.5998C6.89219 15.7883 7.38138 15.8847 7.87522 15.8837C8.36905 15.8826 8.85782 15.784 9.31344 15.5935C9.76906 15.403 10.1826 15.1244 10.5302 14.7737L11.5907 13.7132L12.652 14.7737V14.7729ZM12.121 6.81768L13.1822 7.87893L7.87899 13.1814L6.81774 12.1209L12.121 6.81843V6.81768Z" fill="#525866"/></svg>',
                'route'   => [
                    'name' => 'links'
                ]
            ],
            'creatives' => [
                'title'   => __('Promo Materials', 'fluent-affiliate'),
                'enabled' => false,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.1504 3.875L6.58691 6.12207L6.12305 6.30957L6.31055 6.77246L9.96289 15.8135L10.1504 16.2773L10.6143 16.0898L16.1777 13.8418L16.6416 13.6543L16.4541 13.1914L12.8018 4.15137L12.6143 3.6875L12.1504 3.875ZM7.46387 10.9629L6.50098 11.1504V15.75H9.39844L9.12109 15.0625L7.46387 10.9629ZM5.03711 10.3799L3.78223 13.4854L3.59863 13.9414L4.05078 14.1328L5.30566 14.666L6.00098 14.9619V10.5674L5.03711 10.3799ZM8.63379 7.18262C8.69526 7.15785 8.76417 7.15869 8.8252 7.18457C8.88618 7.21053 8.93414 7.25983 8.95898 7.32129C8.98375 7.38277 8.98389 7.45167 8.95801 7.5127C8.93207 7.57375 8.88182 7.62162 8.82031 7.64648C8.75882 7.67126 8.68993 7.67045 8.62891 7.64453C8.56813 7.61863 8.51998 7.56999 8.49512 7.50879C8.47027 7.44726 8.47113 7.37748 8.49707 7.31641C8.52302 7.25569 8.57162 7.20743 8.63281 7.18262H8.63379ZM6.00098 15.4609L5.68848 15.334L3.17578 14.3193C3.11437 14.2945 3.06494 14.2465 3.03906 14.1855C3.01318 14.1245 3.01322 14.0556 3.03809 13.9941L5.78711 7.1875L5.86328 7L5.78711 6.8125L5.56641 6.26562C5.55414 6.23528 5.54761 6.20265 5.54785 6.16992C5.54814 6.13718 5.55462 6.10437 5.56738 6.07422C5.58022 6.04399 5.59961 6.01617 5.62305 5.99316C5.64632 5.97038 5.67392 5.95266 5.7041 5.94043V5.93945L12.6582 3.13086C12.7196 3.10608 12.7886 3.10597 12.8496 3.13184C12.9106 3.15771 12.9585 3.20715 12.9834 3.26855L17.1982 13.6992C17.2105 13.7296 17.2171 13.7621 17.2168 13.7949C17.2165 13.8278 17.2091 13.8604 17.1963 13.8906C17.1835 13.9207 17.1649 13.9478 17.1416 13.9707C17.1183 13.9936 17.0909 14.0121 17.0605 14.0244H17.0596L10.1064 16.834H10.1055C10.0751 16.8462 10.0425 16.8528 10.0098 16.8525C9.97703 16.8522 9.9442 16.8448 9.91406 16.832C9.88406 16.8192 9.85684 16.8006 9.83398 16.7773C9.81107 16.754 9.79255 16.7266 9.78027 16.6963V16.6953L9.71387 16.5322L9.25098 16.6221V16.25H6.25098C6.18467 16.25 6.1211 16.2236 6.07422 16.1768C6.02735 16.1299 6.00098 16.0663 6.00098 16V15.4609Z" stroke="currentColor"/></svg>',
                'route'   => [
                    'name' => 'creatives'
                ]
            ],
            'referrals'   => [
                'title'   => __('Referrals', 'fluent-affiliate'),
                'enabled' => true,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.125 6.25C12.7798 6.25 12.5 5.97018 12.5 5.625C12.5 5.27982 12.7798 5 13.125 5C13.4702 5 13.75 5.27982 13.75 5.625C13.75 5.97018 13.4702 6.25 13.125 6.25ZM13.125 7.5C14.1606 7.5 15 6.66053 15 5.625C15 4.58947 14.1606 3.75 13.125 3.75C12.0894 3.75 11.25 4.58947 11.25 5.625C11.25 6.66053 12.0894 7.5 13.125 7.5ZM6.875 4.375C5.49429 4.375 4.375 5.49429 4.375 6.875V8.125H5.625V6.875C5.625 6.18464 6.18464 5.625 6.875 5.625H8.75V4.375H6.875ZM13.125 15.625C14.5057 15.625 15.625 14.5057 15.625 13.125V11.875H14.375V13.125C14.375 13.8154 13.8154 14.375 13.125 14.375H11.25V15.625H13.125ZM7.5 10.625C7.5 10.2798 7.22018 10 6.875 10C6.52982 10 6.25 10.2798 6.25 10.625C6.25 10.9702 6.52982 11.25 6.875 11.25C7.22018 11.25 7.5 10.9702 7.5 10.625ZM8.75 10.625C8.75 11.6606 7.91053 12.5 6.875 12.5C5.83947 12.5 5 11.6606 5 10.625C5 9.58944 5.83947 8.75 6.875 8.75C7.91053 8.75 8.75 9.58944 8.75 10.625ZM13.125 9.375C12.4346 9.375 11.875 9.93463 11.875 10.625H10.625C10.625 9.24431 11.7443 8.125 13.125 8.125C14.5057 8.125 15.625 9.24431 15.625 10.625H14.375C14.375 9.93463 13.8154 9.375 13.125 9.375ZM5.625 15.625C5.625 14.9346 6.18464 14.375 6.875 14.375C7.56536 14.375 8.125 14.9346 8.125 15.625H9.375C9.375 14.2443 8.25571 13.125 6.875 13.125C5.49429 13.125 4.375 14.2443 4.375 15.625H5.625Z" fill="#525866"/></svg>',
                'route'   => [
                    'name' => 'referrals'
                ]
            ],
            'payouts' => [
                'title'   => __('Payouts', 'fluent-affiliate'),
                'enabled' => true,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 16H17.5V17.5H2.5V16ZM4 10H5.5V15.25H4V10ZM7.75 10H9.25V15.25H7.75V10ZM10.75 10H12.25V15.25H10.75V10ZM14.5 10H16V15.25H14.5V10ZM2.5 6.25L10 2.5L17.5 6.25V9.25H2.5V6.25ZM4 7.177V7.75H16V7.177L10 4.177L4 7.177ZM10 7C9.80109 7 9.61032 6.92098 9.46967 6.78033C9.32902 6.63968 9.25 6.44891 9.25 6.25C9.25 6.05109 9.32902 5.86032 9.46967 5.71967C9.61032 5.57902 9.80109 5.5 10 5.5C10.1989 5.5 10.3897 5.57902 10.5303 5.71967C10.671 5.86032 10.75 6.05109 10.75 6.25C10.75 6.44891 10.671 6.63968 10.5303 6.78033C10.3897 6.92098 10.1989 7 10 7Z" fill="#525866"/></svg>',
                'route'   => [
                    'name' => 'payouts'
                ]
            ],
            'visits' => [
                'title'   => __('Visits', 'fluent-affiliate'),
                'enabled' => true,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 3.25C14.044 3.25 17.4085 6.16 18.1143 10C17.4093 13.84 14.044 16.75 10 16.75C5.95601 16.75 2.59151 13.84 1.88576 10C2.59076 6.16 5.95601 3.25 10 3.25ZM10 15.25C11.5296 15.2497 13.0138 14.7301 14.2097 13.7764C15.4055 12.8226 16.2422 11.4912 16.5828 10C16.2409 8.50998 15.4037 7.18 14.208 6.22752C13.0122 5.27504 11.5287 4.7564 10 4.7564C8.47128 4.7564 6.98777 5.27504 5.79204 6.22752C4.5963 7.18 3.75908 8.50998 3.41726 10C3.75783 11.4912 4.59451 12.8226 5.79037 13.7764C6.98622 14.7301 8.47041 15.2497 10 15.25ZM10 13.375C9.1049 13.375 8.24646 13.0194 7.61352 12.3865C6.98059 11.7535 6.62501 10.8951 6.62501 10C6.62501 9.10489 6.98059 8.24645 7.61352 7.61351C8.24646 6.98058 9.1049 6.625 10 6.625C10.8951 6.625 11.7536 6.98058 12.3865 7.61351C13.0194 8.24645 13.375 9.10489 13.375 10C13.375 10.8951 13.0194 11.7535 12.3865 12.3865C11.7536 13.0194 10.8951 13.375 10 13.375ZM10 11.875C10.4973 11.875 10.9742 11.6775 11.3258 11.3258C11.6775 10.9742 11.875 10.4973 11.875 10C11.875 9.50272 11.6775 9.02581 11.3258 8.67417C10.9742 8.32254 10.4973 8.125 10 8.125C9.50273 8.125 9.02581 8.32254 8.67418 8.67417C8.32255 9.02581 8.12501 9.50272 8.12501 10C8.12501 10.4973 8.32255 10.9742 8.67418 11.3258C9.02581 11.6775 9.50273 11.875 10 11.875Z" fill="#525866"/></svg>',
                'route'   => [
                    'name' => 'visits'
                ]
            ],
            'settings' => [
                'title'   => __('Settings', 'fluent-affiliate'),
                'enabled' => true,
                'icon'    => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 9.99998C2.5 9.35123 2.5825 8.72273 2.737 8.12198C3.15135 8.14377 3.56365 8.05055 3.92833 7.85264C4.29301 7.65472 4.59586 7.35983 4.8034 7.00054C5.01095 6.64126 5.1151 6.23158 5.10436 5.8168C5.09361 5.40202 4.96837 4.99829 4.7425 4.65023C5.64921 3.75816 6.7681 3.11161 7.99375 2.77148C8.18199 3.14159 8.46898 3.45238 8.82294 3.66947C9.1769 3.88655 9.58402 4.00145 9.99925 4.00145C10.4145 4.00145 10.8216 3.88655 11.1756 3.66947C11.5295 3.45238 11.8165 3.14159 12.0048 2.77148C13.2304 3.11161 14.3493 3.75816 15.256 4.65023C15.0299 4.99835 14.9045 5.40224 14.8936 5.81721C14.8828 6.23218 14.987 6.64206 15.1946 7.00149C15.4023 7.36093 15.7054 7.65591 16.0703 7.8538C16.4352 8.05168 16.8477 8.14476 17.2623 8.12273C17.4167 8.72273 17.4993 9.35123 17.4993 9.99998C17.4993 10.6487 17.4167 11.2772 17.2623 11.878C16.8478 11.8561 16.4354 11.9492 16.0706 12.147C15.7059 12.3449 15.4029 12.6398 15.1953 12.9991C14.9876 13.3584 14.8834 13.7681 14.8941 14.183C14.9048 14.5978 15.0301 15.0016 15.256 15.3497C14.3493 16.2418 13.2304 16.8884 12.0048 17.2285C11.8165 16.8584 11.5295 16.5476 11.1756 16.3305C10.8216 16.1134 10.4145 15.9985 9.99925 15.9985C9.58402 15.9985 9.1769 16.1134 8.82294 16.3305C8.46898 16.5476 8.18199 16.8584 7.99375 17.2285C6.7681 16.8884 5.64921 16.2418 4.7425 15.3497C4.96863 15.0016 5.09405 14.5977 5.10488 14.1828C5.11571 13.7678 5.01152 13.3579 4.80386 12.9985C4.59619 12.639 4.29314 12.3441 3.92823 12.1462C3.56332 11.9483 3.15078 11.8552 2.73625 11.8772C2.5825 11.278 2.5 10.6495 2.5 9.99998ZM6.103 12.25C6.5755 13.0682 6.7105 14.0095 6.526 14.893C6.832 15.1105 7.1575 15.2987 7.49875 15.4555C8.18625 14.8396 9.07699 14.4993 10 14.5C10.945 14.5 11.8285 14.8532 12.5013 15.4555C12.8425 15.2987 13.168 15.1105 13.474 14.893C13.2846 13.99 13.4352 13.0488 13.897 12.25C14.358 11.4508 15.0978 10.8499 15.9745 10.5625C16.0092 10.1883 16.0092 9.81168 15.9745 9.43748C15.0975 9.15028 14.3574 8.54935 13.8962 7.74998C13.4345 6.95118 13.2838 6.01001 13.4733 5.10698C13.1673 4.88943 12.8417 4.7011 12.5005 4.54448C11.8132 5.16018 10.9228 5.50044 10 5.49998C9.07699 5.50063 8.18625 5.16036 7.49875 4.54448C7.1576 4.7011 6.83192 4.88943 6.526 5.10698C6.71542 6.01001 6.56479 6.95118 6.103 7.74998C5.64203 8.5492 4.90224 9.15012 4.0255 9.43748C3.99081 9.81168 3.99081 10.1883 4.0255 10.5625C4.90252 10.8497 5.6426 11.4506 6.10375 12.25H6.103ZM10 12.25C9.40326 12.25 8.83097 12.0129 8.40901 11.591C7.98705 11.169 7.75 10.5967 7.75 9.99998C7.75 9.40325 7.98705 8.83095 8.40901 8.40899C8.83097 7.98704 9.40326 7.74998 10 7.74998C10.5967 7.74998 11.169 7.98704 11.591 8.40899C12.0129 8.83095 12.25 9.40325 12.25 9.99998C12.25 10.5967 12.0129 11.169 11.591 11.591C11.169 12.0129 10.5967 12.25 10 12.25ZM10 10.75C10.1989 10.75 10.3897 10.671 10.5303 10.5303C10.671 10.3897 10.75 10.1989 10.75 9.99998C10.75 9.80107 10.671 9.61031 10.5303 9.46965C10.3897 9.329 10.1989 9.24998 10 9.24998C9.80109 9.24998 9.61032 9.329 9.46967 9.46965C9.32902 9.61031 9.25 9.80107 9.25 9.99998C9.25 10.1989 9.32902 10.3897 9.46967 10.5303C9.61032 10.671 9.80109 10.75 10 10.75Z" fill="#525866"/></svg>',
                'route'   => [
                    'name' => 'settings'
                ]
            ]
        ], $affiliate);
    }

    public static function getSuggestedColors()
    {
        $pallets = current((array) get_theme_support('editor-color-palette'));

        $colors = [];
        if ($pallets && is_array($pallets)) {
            $colors = array_map(function ($color) {
                $colorString = Arr::get($color, 'color');
                $colorString = trim($colorString);
                if (strpos($colorString, 'var(') === 0) {
                    preg_match('/var\(.*,\s*(#[A-Fa-f0-9]{6})\)/', $colorString, $matches);
                    if (!empty($matches[1])) {
                        return $matches[1];
                    }
                    return '';
                }

                if (preg_match('/#[A-Fa-f0-9]{6}/', $colorString, $matches)) {
                    return $matches[0];
                }

                return $colorString;
            }, $pallets);

            $colors = array_filter($colors);
        }

        if (!$colors) {
            $colors = ['#000000', '#abb8c3', '#f78da7', '#ff6900', '#fcb900', '#7bdcb5', '#00d084', '#8ed1fc', '#0693e3', '#9b51e0'];
        }

        return apply_filters('fluent_affiliate/suggested_colors', $colors);
    }
}
